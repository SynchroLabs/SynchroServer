require('./test');

var assert = require("assert")
require("./assert-helper");

var lodash = require('lodash');

var CommandInstance = require('../client/core/command-instance');
var JToken = require('../client/core/json');
var bindingContext = require('../client/core/binding-context');

describe("CommandInstance", function () 
{
    var viewModel =
    {
        "serial": 69,
        "title": "The Title",
        "board":
        [
            [
                { "name": "s00" },
                { "name": "s01" }
            ],
            [
                { "name": "s10" },
                { "name": "s11" }
            ]
        ]
    };

    it("should resolve parameters", function()
    {
        var cmdInst = new CommandInstance("TestCmd");
        var bindingCtx = new bindingContext.createRootBindingContext(new JToken(viewModel));

        cmdInst.setParameter("Literal", "literal");
        cmdInst.setParameter("Serial", "{serial}");
        cmdInst.setParameter("Title", "{title}");
        cmdInst.setParameter("Empty", "");
        cmdInst.setParameter("Obj", "{board[0][1]}");
        cmdInst.setParameter("Number", 69);
        cmdInst.setParameter("Boolean", true);
        cmdInst.setParameter("NULL", null);          // This can't happen in nature, but just for fun...
        cmdInst.setParameter("Parent", "{$parent}"); // Token that can't be resolved ($parent from root)
        cmdInst.setParameter("Nonsense", "{foo}");   // Token that can't be resolved

        var resolvedParams = cmdInst.getResolvedParameters(bindingCtx);
        assert.equal(resolvedParams["Literal"], "literal");
        assert.equal(resolvedParams["Serial"], 69);
        assert.equal(resolvedParams["Title"], "The Title");
        assert.equal(resolvedParams["Empty"], "");
        assert(lodash.isEqual(resolvedParams["Obj"], viewModel.board[0][1]));
        assert.equal(resolvedParams["Number"], 69);
        assert.equal(resolvedParams["Boolean"], true);
        assert.equal(resolvedParams["NULL"], null);
        assert.equal(resolvedParams["Parent"], null);
        assert.equal(resolvedParams["Nonsense"], null);
    });
});
