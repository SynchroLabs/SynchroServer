// SynchroWebClient server
//
var path = require('path');
var express = require('express');
var logger = require('log4js').getLogger("synchro-web-client");

var hbs = require('express-hbs');

var render = hbs.create().express3({
    partialsDir: __dirname + '/views/partials',
    contentHelperName: 'content'
});

var SynchroWeb = function(config, basePath, apiPath)
{
    this.config = config;
    this.basePath = basePath; // Where this service is served (not including trailing slash)
    this.apiPath = apiPath;   // Where apps are served (not including trailing slash)

    this.endpointPath = null;
    if (apiPath.match(/^https?:\/\/.*/))
    {
        // If the apiPath is fully specified, winner! (this will be the case when launched locally from app.js)
        this.endpointPath = apiPath;
    }
};

// Called before the Express router or any routes are added to the app.  This is a good time to add any
// static middleware.
//
SynchroWeb.prototype.addMiddleware = function(expressApp)
{
    // We need this to serve bundle.js (the main script bundle) and possibly other resources later.
    //
    logger.debug("Adding static path from basePath: " + this.basePath);
    logger.debug("Static path is: " + path.join(__dirname, 'public'));
    expressApp.use(this.basePath, express.static(path.join(__dirname, 'public')));
}

SynchroWeb.prototype.addRoutes = function(expressApp, config)
{
    var self = this;
    expressApp.get(this.basePath + '/:appName', function(req,res)
    {
        if (self.endpointPath == null)
        {
            // If the apiPath was relative, then we create the endpoint using current request info.  
            //
            // !!! Note: It might be better to use the config for external facing protocol/host/port for cases like Azure
            //           where the actual request info probably won't be routable.  Investigate using the same settings that
            //           Studio uses for publishing the endpoints for end user consumption.
            //
            self.endpointPath = req.protocol + "://" + self.config.addNonStandardPort(req.host, req.port) + self.apiPath;
        }

        var locals = { endpoint:  self.endpointPath + '/' + req.params.appName };
        locals.settings = { views: path.join(__dirname, '/views') };

        logger.info("Locals:", JSON.stringify(locals, null, 4));

        render(locals.settings.views + '/index.hbs', locals, function(err, html) 
        {
            if (err)
            {
                logger.error("Error:", err);
            }
            else
            {
                res.send(html);
            }
        });
    });
}

module.exports = SynchroWeb
