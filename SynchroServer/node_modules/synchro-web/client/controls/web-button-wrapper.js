var logger = require('log4js').getLogger("web-button-wrapper");

var WebControlWrapper = require('./web-control-wrapper');

var glyphMapper = require('../core/glyph-mapper');

var binding = require('../core/binding');
var CommandInstance = require('../core/command-instance');

var WebButtonWrapper = function(parent, bindingContext, controlSpec)
{
    var self = this;

    this.base = WebControlWrapper;
    this.base(parent, bindingContext, controlSpec);
    logger.debug("Button control created");

    var button = document.createElement("button");
    button.classList.add("synchro-button");

    this._control = button;

    if (controlSpec["borderless"])
    {
        logger.debug("Button is borderless");
        button.classList.add("synchro-borderless");
    }

    this.processElementProperty(controlSpec, "caption", function(value) 
    { 
        button.innerHTML = self.toString(value);
        if (self._iconElement)
        {
            // If there is an icon, we need to re-insert it (setting innerHTML will have blown it away)
            button.insertBefore(self._iconElement, button.firstChild);
        }
    });

    this.processElementProperty(controlSpec, "icon", function(value) 
    {
        var icon =  self.toString(value);
        var iconGlyph = glyphMapper.getGlyph(icon);

        logger.debug("Icon set to glyph %s, mapped to entity: %s", icon, iconGlyph);

        if (!self._iconElement)
        {
            logger.error("Had to create icon element for button with icon:", icon);
            self._iconElement = document.createElement("i");
            self._iconElement.classList.add("material-icons");
            button.insertBefore(self._iconElement, button.firstChild);
        }

        self._iconElement.innerHTML = iconGlyph;
    });

    this.processElementProperty(controlSpec, "resource", function(value) 
    {
        button.style.backgroundImage = "url('" + self.toString(value) + "')";
        button.style.backgroundSize = '100%';
    });

    var bindingSpec = binding.getCanonicalBindingSpec(controlSpec, CommandInstance.commandNames.OnClick, WebButtonWrapper.commands);

    this.processCommands(bindingSpec, WebButtonWrapper.commands);

    if (this.getCommand(CommandInstance.commandNames.OnClick) != null)
    {
        // Attach a handler
        logger.debug("Adding button click handler");
        button.addEventListener("click", this.OnClick.bind(this), false);
    }
}
WebButtonWrapper.prototype = Object.create(WebControlWrapper.prototype);

WebButtonWrapper.commands = [ CommandInstance.commandNames.OnClick ];

WebButtonWrapper.prototype.OnClick = function()
{
    logger.info("Button clicked:", this._control.innerHTML);
    var command = this.getCommand(CommandInstance.commandNames.OnClick);
    if (command != null)
    {
        logger.info("Button click with command: %s", command.getCommand());
        this._stateManager.sendCommandRequestAsync(command.getCommand(), command.getResolvedParameters(this._bindingContext));
    }
}

module.exports = WebButtonWrapper;
