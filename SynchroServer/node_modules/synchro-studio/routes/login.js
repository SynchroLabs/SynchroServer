var logger = require('log4js').getLogger("studio-login");

exports.login = function(synchroStudio, req, res, message)
{
    var post = req.body;
    if (post && post.username)
    {
        var users = synchroStudio.config.get("STUDIO_USERS") || {};
        if (users[post.username] && synchroStudio.config.comparePassword(post.password, users[post.username]))
        {
            req.session.user_id = post.username;
            var nextPage = "/studio/samples/sandbox"; // default
            if (req.session.nextPage)
            {
                nextPage = req.session.nextPage;
                req.session.nextPage = null;
            }
            res.redirect(nextPage);
        }
        else 
        {
            synchroStudio.render('login', { warning: "Username and password combination were not correct" }, res);
        }
    }
    else
    {
        synchroStudio.render('login', { warning: req.session.loginMessage }, res);
        req.session.loginMessage = null;
    }
};

exports.logout = function(synchroStudio, req, res)
{
    delete req.session.user_id;
    req.session.loginMessage = "You have been signed out";
    res.redirect('/');
}

exports.checkAuth = function(req, res, next) 
{
    if (!req.session.user_id)
    {
        req.session.loginMessage = "The page you have attempted to access requires that you be signed in";
        req.session.nextPage = req.path;
        res.redirect('login');
    }
    else 
    {
        next();
    }
}
