// This is the static prefix resource resolver. 
//
var logger = require('log4js').getLogger("resource-resolver");

module.exports = function(params)
{
    // params.prefix
    // params.serverUrlBase
    // params.hostGuess (local IP address plus port - usually a poor guess)

    var prefix = params.prefix;
    if (prefix.substr(-1) != '/')
    {
        prefix += '/';
    }

    var resourceResolver = 
    {
        getResourceUrl: function(param1, param2)
        {
            var context = null;
            var resource;

            if (param2)
            {
                context = param1;
                resource = param2;
            }
            else
            {
                resource = param1;
            }

            if (!prefix.match(/^https?:\/\/.*/))
            {
                // Prefix was not fully specified
                //
                if (params.serverUrlBase)
                {
                    // If we have a definitive server URL base, we will use that to resolve non-fully-qualified prefixes
                    //
                    logger.debug("Resolving resource '%s' with explicit server url base: %s", resource, params.serverUrlBase);
                    resource = params.serverUrlBase + prefix + resource;
                }
                else if (context)
                {
                    // If we don't have an explicit server URL base, we will construct one from the host and secure 
                    // properties of the request.
                    //
                    logger.debug("Resolving resource '%s' with host: %s, secure: %s", resource, context.request.Host, context.request.Secure);
                    resource = (context.request.Secure ? 'https' : 'http') + '://' + context.request.Host + prefix + resource;
                }
                else
                {
                    logger.debug("Resolving resource '%s' with host guess: %s", resource, params.hostGuess);
                    resource = params.hostGuess + prefix + resource;
                }
            }
            else
            {
                logger.debug("Resolving resource '%s' with fully resolved prefix: %s", resource, prefix);
                resource = prefix + resource;
            }

            logger.debug("Resource resolved to:", resource);

            return resource;
        }
    }

    return resourceResolver;
}
