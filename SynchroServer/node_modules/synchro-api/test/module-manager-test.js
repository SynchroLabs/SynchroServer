require('./test');

var assert = require("assert");
require("./assert-helper");

var fs = require('fs');
var path = require('path');
var util = require("../lib/util");

var logger = require('log4js').getLogger("module-manager-test");

describe("Module Manager", function()
{
    var appRootPath = path.resolve(__dirname);
    var moduleDirectory = path.resolve(__dirname, 'testapp');

    logger.info("moduleDirectory: " + moduleDirectory);

    var moduleSources = {};

    var moduleStore = 
    {
        getAppModuleStoreAwaitable: function * (container)
        {
            var app =
            {
                getAppDefinitionAwaitable: function * ()
                {
                    var appDefinitionPath = path.resolve(moduleDirectory, "package.json");
                    var content = util.removeBOM(fs.readFileSync(appDefinitionPath, 'utf8'));
                    logger.info("got app def: " + content);
                    return JSON.parse(content);
                },
                    
                listModulesAwaitable: function * ()
                {
                    return ["menu.js", "counter.js"];
                },
                    
                getModuleSourceAwaitable: function * (moduleFilename)
                {
                    if (!moduleSources[moduleFilename])
                    {
                        var moduleFilePath = path.resolve(moduleDirectory, moduleFilename);
                        moduleSources[moduleFilename] = util.removeBOM(fs.readFileSync(moduleFilePath, 'utf8'));
                    }
                    return moduleSources[moduleFilename];
                },
                    
                putModuleSourceAwaitable: function * (moduleFilename, content)
                {
                    moduleSources[moduleFilename] = content;
                },
                    
                removeModuleSourceAwaitable: function * (moduleFilename)
                {
                    delete moduleSources[moduleFilename];
                }
            }

            return app;
        }
    };

    var resourceResolver =
    {
        getResourceUrl: function(resource)
        {
            return "test:" + resource;
        }
    };

    var moduleManager;

    before(function *()
    {
        logger.info("Before");
        moduleManager = yield require('../lib/module-manager')(moduleStore, appRootPath, "container", resourceResolver);
        logger.info("After");
    });

    it("should get proper app definition on loadRoutes", function * () 
    {
        var appDefinition = yield moduleManager.loadRoutesAwaitable();
        var expectedAppDefinition = 
        {
            "name": "synchro-test",
            "version": "0.0.0",
            "description": "Synchro API Test",
            "main": "launch",
            "author": "Bob Dickinson <bob@synchro.io> (http://synchro.io/)",
            "private": true,
            "engines": { "synchro": "*" }
        }
        assert.objectsEqual(appDefinition, expectedAppDefinition);
    });

    it("should get loaded modules via getModule", function()
    {
        var menu = moduleManager.getModule("menu");
        var menuViewModel = menu.InitializeViewModel({}, {});
        assert.objectsEqual(menuViewModel, { test: "testValue" });

        var counter = moduleManager.getModule("counter");
        var counterViewModel = counter.InitializeViewModel({}, {});
        assert.objectsEqual(counterViewModel, { count: 0 });
    });

    it("should get correct view from loaded module", function()
    {
        var menu = moduleManager.getModule("menu");
        var view = 
        {
            title: "Menu",
            elements: 
            [
		        { control: "button", caption: "Counter", binding: "goToCounter" },
	        ]
        };
        assert.objectsEqual(menu.View, view);
    });

    it("should be able to load a module with dynamic view only, and get correct view from same", function()
    {
        // This used to fail (fail to load the module at all, because it lacked the View member)
        //
        var counter = moduleManager.getModule("counter");
        var view = 
        {
            title: "Counter Page",
            onBack: "exit",
            elements: 
            [
                { control: "text", value: "Count: {count}", font: 24 },
            ]
        };
        assert.objectsEqual(counter.View, undefined);
        assert.objectsEqual(counter.InitializeView(), view);
    });

    it("should be able to access app services from loaded module", function() 
    {
        var counter = moduleManager.getModule("counter");
        var counterViewModel = counter.InitializeViewModel({}, {});
        assert.objectsEqual(counterViewModel, { count: 0 });

        // This will do a Synchro.getResourceUrl() in the module
        counter.Commands.test({}, {}, counterViewModel);
        assert.objectsEqual(counterViewModel, { count: 0, url: "test:user.png" });
    });

    it("should update already loaded module instance with new module content on reloadModule, reflecting provided source", function * ()
    {
        var counter = moduleManager.getModule("counter");
        var counterViewModel = counter.InitializeViewModel({}, {});
        assert.objectsEqual(counterViewModel, { count: 0 });

        counter.Commands.inc({}, {}, counterViewModel);
        assert.objectsEqual(counterViewModel, { count: 1 });

        var moduleFilePath = path.resolve(moduleDirectory, "counter_update.js");
        var content = util.removeBOM(fs.readFileSync(moduleFilePath, 'utf8'));

        yield moduleManager.reloadModuleAwaitable("counter.js", content);

        counter = moduleManager.getModule("counter");
        counter.Commands.inc({}, {}, counterViewModel);
        assert.objectsEqual(counterViewModel, { count: 6 });
    });

    it("should update already loaded module instance with module content from module store on reloadModule", function * ()
    {
        // Reset module store so it will reload modules from the file system (otherwise reloaded counter from previous
        // test would already be loaded).
        //
        moduleSources = {};

        var counter = moduleManager.getModule("counter");
        var counterViewModel = counter.InitializeViewModel({}, {});
        assert.objectsEqual(counterViewModel, { count: 0 });
        
        counter.Commands.inc({}, {}, counterViewModel);
        assert.objectsEqual(counterViewModel, { count: 5 });
                
        yield moduleManager.reloadModuleAwaitable("counter.js");
        
        counter = moduleManager.getModule("counter");
        counter.Commands.inc({}, {}, counterViewModel);
        assert.objectsEqual(counterViewModel, { count: 6 });
    });
});