var test = require('./test');

var assert = require("assert")
require("./assert-helper");

var ReaderWriter = require("../lib/reader-writer");
var readerWriter = new ReaderWriter();

var logger = require('log4js').getLogger("reader-writer-test");

describe("Reader-Writer", function()
{
	var channelId = "69";

	beforeEach(function()
	{
		readerWriter.drain();
	});

	it("should report no read pending when no read pending", function()
	{
		assert.equal(readerWriter.isReadPending(channelId), false);
	});

	it("should report no write pending when no write pending", function()
	{
		assert.equal(readerWriter.isWritePending(channelId), false);
	});

	it("should report read pending when read pending", function * ()
	{
		yield readerWriter.readAsync(channelId, function * (err, data){});
		assert.equal(readerWriter.isReadPending(channelId), true);
	});

	it("should report write pending when write pending", function * ()
	{
		yield readerWriter.readAsync(channelId, function * (err, data){});
		assert.equal(readerWriter.isReadPending(channelId), true);
	});

	it("should report proper write pending status before and after satisfied write", function * ()
	{
		assert.equal(readerWriter.isReadPending(channelId), false);
		assert.equal(readerWriter.isWritePending(channelId), false);
		yield readerWriter.writeAsync(channelId, function * (err, writeData)
		{
			assert.equal(readerWriter.isReadPending(channelId), false);
			assert.equal(readerWriter.isWritePending(channelId), false);
			yield writeData("the data");
		});

		assert.equal(readerWriter.isReadPending(channelId), false);
		assert.equal(readerWriter.isWritePending(channelId), true);

		yield readerWriter.readAsync(channelId, function * (err, data)
		{
			assert.equal(readerWriter.isReadPending(channelId), false);
			assert.equal(readerWriter.isWritePending(channelId), false);
			test.recordCall();
		});

		test.assertDone();
	});

	it("should report proper read pending status before and after satisfied read", function * ()
	{
		assert.equal(readerWriter.isReadPending(channelId), false);
		assert.equal(readerWriter.isWritePending(channelId), false);

		yield readerWriter.readAsync(channelId, function *(err, data)
		{
			assert.equal(readerWriter.isReadPending(channelId), false);
			assert.equal(readerWriter.isWritePending(channelId), false);
			test.recordCall();
		});

		assert.equal(readerWriter.isReadPending(channelId), true);
		assert.equal(readerWriter.isWritePending(channelId), false);

		yield readerWriter.writeAsync(channelId, function * (err, writeData)
		{
			assert.equal(readerWriter.isReadPending(channelId), false);
			assert.equal(readerWriter.isWritePending(channelId), false);
			yield writeData("the data");
		});

		test.assertDone();
	});

	it("should cancel pending read", function * ()
	{
		assert.equal(readerWriter.isReadPending(channelId), false);
		assert.equal(readerWriter.isWritePending(channelId), false);

		yield readerWriter.readAsync(channelId, function * (err, data){});

		assert.equal(readerWriter.isReadPending(channelId), true);
		assert.equal(readerWriter.isWritePending(channelId), false);

		readerWriter.cancelRead(channelId);

		assert.equal(readerWriter.isReadPending(channelId), false);
		assert.equal(readerWriter.isWritePending(channelId), false);
	});

	it("should cancel pending write", function * ()
	{
		assert.equal(readerWriter.isReadPending(channelId), false);
		assert.equal(readerWriter.isWritePending(channelId), false);

		yield readerWriter.writeAsync(channelId, function * (err, writeData){});

		assert.equal(readerWriter.isReadPending(channelId), false);
		assert.equal(readerWriter.isWritePending(channelId), true);

		readerWriter.cancelWrite(channelId);

		assert.equal(readerWriter.isReadPending(channelId), false);
		assert.equal(readerWriter.isWritePending(channelId), false);
	});

	it("should complete correctly when write posted before read", function * ()
	{
		yield readerWriter.writeAsync(channelId, function * (err, writeData)
		{
			assert.equal(err, null);
			yield writeData("the data");
		});

		yield readerWriter.readAsync(channelId, function * (err, data)
		{
			assert.equal(err, null);
			assert.equal("the data", data);
			test.recordCall();
		});

		test.assertDone();
	});

	it("should complete correctly when read postred before write", function * ()
	{
		yield readerWriter.readAsync(channelId, function * (err, data)
		{
			assert.equal(err, null);
			assert.equal(data, "the data");
			test.recordCall();
		});

		yield readerWriter.writeAsync(channelId, function * (err, writeData)
		{
			assert.equal(err, null);
			yield writeData("the data");
		});

		test.assertDone();
	});

	it("should get read data from cooresponding write", function * ()
	{
		yield readerWriter.writeAsync("different channel", function * (err, writeData)
		{
			assert(false, "Write for this channel should not get called");
		});

		yield readerWriter.writeAsync(channelId, function * (err, writeData)
		{
			assert.equal(err, null);
			yield writeData("the data");
		});

		yield readerWriter.writeAsync("yet a different channel", function * (err, writeData)
		{
			assert(false, "Write for this channel should not get called");
		});

		yield readerWriter.readAsync(channelId, function * (err, data)
		{
			assert.equal(err, null);
			assert.equal(data, "the data");
			test.recordCall();
		});

		test.assertDone();
	});

	it("should fail to post read with pending read on same channel", function * ()
	{
		yield readerWriter.readAsync(channelId, function * (err, data)
		{
			assert(false, "Should not get here");
		});

		yield readerWriter.readAsync(channelId, function * (err, data)
		{
			assert.notEqual(err, null);
			assert.equal(data, null);
			test.recordCall();
		});

		test.assertDone();
	});

	it("should fail to post write with pending write on same channel", function * ()
	{
		yield readerWriter.writeAsync(channelId, function * (err, writeData)
		{
			assert(false, "Should not get here");
		});

		yield readerWriter.writeAsync(channelId, function * (err, writeData)
		{
			assert.notEqual(err, null);
			assert.equal(writeData, null);
			test.recordCall();
		});

		test.assertDone();
	});
});